flowchart TD
 subgraph s1["提示词2"]
        H["使用qwen2.5-3B
    结合历史query信息生成规范化query"]
  end
 subgraph s2["提示词1"]
        G{"使用qwen2.5-1.5B/3B
    判断是否需要改写"}
  end
    A["接收查询请求"] --> B{"参数验证"}
    B -- 验证失败 --> C["返回错误码"]
    B -- 验证成功 --> D{"检查query长度"}
    D -- 超过128字符 --> K["使用原始查询"]
    D -- 长度合规 --> G
    G -- false --> K
    G -- true --> H
    H --> P1{"输出格式验证"}
    P1 -- 不合规 --> P2["格式修正"]
    P1 -- 合规 --> P3["输出清洗"]
    P2 --> P3
    P3 --> L["组装响应数据"]
    K --> L
    L --> M["返回优化结果"]