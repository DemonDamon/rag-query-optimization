flowchart TD
    A[接收查询请求] --> B{参数验证}
    B -->|验证失败| C[返回错误码1001]
    B -->|验证成功| D{检查query长度}
    D -->|超过maxQueryLength| E[返回错误码1002]
    D -->|长度合规| F{确定优化类型}
    
    F -->|auto| G[分析查询长度]
    G -->|短查询| G1[短查询处理]
    G -->|长查询| G2[长查询处理]
    G1 --> H1{自动选择短查询优化策略}
    G2 --> H2{自动选择长查询优化策略}
    
    H1 -->|意图多样化| I1[生成多样意图扩展]
    H1 -->|意图不清| I2[查询纠错处理]
    H1 -->|隐含信息| I3[补充上下文信息]
    H1 -->|相关性扩充| I4[添加相关意图]
    
    H2 -->|选择transform| I[执行查询改写]
    H2 -->|选择expand| J[执行查询扩展]
    H2 -->|选择decompose| K[执行查询分解]
    
    F -->|transform| I
    F -->|expand| J
    F -->|decompose| K
    
    I1 --> R1[合并短查询结果]
    I2 --> R1
    I3 --> R1
    I4 --> R1
    R1 --> R
    
    I --> L[生成1条改写查询]
    
    J --> M[应用扩展参数]
    M --> N[生成minResultCount~maxResultCount条扩展查询]
    
    K --> O[分析查询逻辑结构]
    O --> P[拆解为多个子查询]
    P --> Q[生成minResultCount~maxResultCount条子查询]
    
    L --> R{应用关键词保留}
    N --> R
    Q --> R
    
    R --> S[组装响应数据]
    S --> T[返回优化结果]